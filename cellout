#!/bin/sh

# (c) Christopher Down 2011
# See the COPYING file for copyright information.

_die() {
    printf '%s\n' "$@" >&2
    exit 1
}

[ "$#" -eq 0 ] && _die "Usage: ${0##*/} battery"

_battery_info_path="/sys/class/power_supply/$1"

for _file in "${_battery_info_path}/charge_full" \
             "${_battery_info_path}/charge_now" \
             "${_battery_info_path}/present" \
             "${_battery_info_path}/status"; do
    [ -r "${_file}" ] || _die "Could not read ${_file}"
done

read -r _batt_charge_full < "${_battery_info_path}/charge_full"
read -r _batt_charge_now  < "${_battery_info_path}/charge_now"
read -r _batt_status      < "${_battery_info_path}/status"
read -r _batt_present     < "${_battery_info_path}/present"

_batt_perc=$(( _batt_charge_now * 100 / _batt_charge_full ))

if   [ "${_batt_perc}" -lt 25 ]; then _batt_perc_graphic='#---';
elif [ "${_batt_perc}" -lt 50 ]; then _batt_perc_graphic='##--';
elif [ "${_batt_perc}" -lt 75 ]; then _batt_perc_graphic='###-';
else                                  _batt_perc_graphic='####'; fi

[ "${_batt_present}" -eq 0 ] && _batt_perc_graphic='MMMM'

printf '[%s] %s%.1s\n' "${_batt_perc_graphic}" "${_batt_perc}" "${_batt_status}"
