#!/bin/ksh

# (c) Christopher Down 2011
# See the COPYING file for copyright information.

_die() {
    printf '%s\n' "$@" >&2
    exit 1
}

(( $# != 1 )) && _die "Usage: $0 battery"

_battery_info_path="/sys/class/power_supply/$1"

for _file in "${_battery_info_path}/"{charge_{full,now},present,status}; do
    [[ -r ${_file} ]] || _die "Could not read ${_file}"
done

_batt_charge_full=$(<"${_battery_info_path}/charge_full")
_batt_charge_now=$(<"${_battery_info_path}/charge_now")
_batt_status=$(<"${_battery_info_path}/status")
_batt_present=$(<"${_battery_info_path}/present")

# ${foo:0:1} sadly doesn't work with pdksh
_batt_status="${_batt_status%${_batt_status#?}}"
_batt_perc=$(( _batt_charge_now * 100 / _batt_charge_full ))

if   (( _batt_perc <  25  )); then _batt_perc_graphic='#---';
elif (( _batt_perc <  50  )); then _batt_perc_graphic='##--';
elif (( _batt_perc <  75  )); then _batt_perc_graphic='###-';
elif (( _batt_perc <= 100 )); then _batt_perc_graphic='####'; fi

(( _batt_present )) || _batt_perc_graphic='MMMM'

printf '[%s] %s%s\n' "${_batt_perc_graphic}" "${_batt_perc}" "${_batt_status}"
